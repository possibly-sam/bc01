---
title: "bc01b"
author: "Phillip Abbott"
date: "September 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}


library(tidyverse)



library(tidytext)
library(tm)
library(e1071)
library(odbc)

library(NLP)
# library(openNLP)

library(odbc)

con <- dbConnect(odbc::odbc(), .connection_string = "Driver={PostgreSQL Unicode};Server=mcfc01.c4hbjfyzingo.eu-west-2.rds.amazonaws.com;Database=mcfc01;UID=mcfcuser01;PWD=projecthack01")


# con <- dbConnect(odbc::odbc(), .connection_string = "Driver={PostgreSQL Unicode};Database=usit_alpha")


```



```{sql connection=con,  output.var="business_cases_year_17"}

SELECT "Brief_Summary" ::varchar(4096), 
  uui01::bigint*1000000000+uui02 AS uui, 
  
  "CIO_Evaluation_Color" from public.business_case_alpha WHERE year=17

```



create a principal component calculator.

given  an index and a list of text :
calculate the most common words (kill stopwords)
determine which entries have which of those -- this gives the raw matrix
determine the principal components of that
find the projection of the original text onto each of the (top) princ. comp.

## Calculation
skip this section if not re-calculating, and just load the result

```{r}

source("pcx01.R")

p0 <- pcx(business_cases_year_17$uui, business_cases_year_17$Brief_Summary)

# : my_corups
# : my_document_term_matrix
# : my_incidence_matrix
# : my_principal_component_matrix
# : my_tidy_dtm


# p0$project_onto_principal_component(2) - p0$project_onto_principal_component(1)
p0$my_projection_matrix %>% View()

# p0$plot_word_counts()
# p0 %>% ls.str()

save(p0, file="p0.RData")


```

## Load the result

```{r}

source("pcx01.R")


load("p0.RData")

p0$plot_word_counts()

```



Let's put some .csv for those who want to analyze that way

```{r}
p0$my_incidence_matrix %>% write_csv("incidence.csv")


p0$my_projection_matrix %>% write_csv("projection.csv")


pc0 <- data.frame(term=p0$my_principal_component_matrix$rotation %>% rownames())            %>%       cbind(p0$my_principal_component_matrix$rotation %>% as.data.frame() ) %>%
  write_csv("princ_comp.csv")



```


# exposition
? What are the most/least common words in each PCX?
? Which are the BC that are most/least representative of each PCX?

```{r}




fn <- function(pcx, n=5) {
  the_pcx <- p0$get_principal_component(n) %>% sort(TRUE)
  h0 <- the_pcx %>% head(n)
  t0 <- the_pcx %>% tail(n)
  x0 <- c(h0, t0) 
  the_col <- c (rep(1,n), rep(2,n))
  x0 %>% barplot( main=paste("Princ. Comp. #", pcx) , col=the_col, cex.lab=.5)  
  legend( "topright",legend= names(x0), cex=.62, fill=the_col)

}

fn(1)

```







```{r}

p0 %>% ls.str()

```




# p0$the_corpus %>% inspect()
# p0$my_document_term_matrix %>% inspect()
#  p0$my_tidy_dtm
# p0$my_word_counts %>% str()

# p0$plot_word_counts()


# dtm <- p0$my_document_term_matrix 
# p0$my_principal_component_matrix %>% summary()
# p0$plot_principal_components ()

the_categories <- rep(1, nrow(business_cases_year_17))
the_categories[ business_cases_year_17$CIO_Evaluation_Color=="Green"] <- 3
the_categories[ business_cases_year_17$CIO_Evaluation_Color=="Red"] <- 2

# p0$ppc_cat(the_categories)

p0$project_row_onto_principal_component(5,1)
# p0$my_projection_matrix %>% head()
p0$project_onto_principal_component(2) %>% head()


# 1:nrow(p0$my_incidence_matrix) %>% map( ~p0$project_row_onto_principal_component(.,1) ) %>% unlist()

q0 <- p0$fn(p0)
colnames(q0) <- colnames(p0$my_principal_component_matrix$rotation)[1:10]
# q0 <- q0 %>% cbind(the_categories)

plot(q0[,1]~q0[,2],col=the_categories)

qqda0 <- qda(the_categories ~ . , data=q0)



```{r}


some_table_information <- function(the_table) {
  
  result <- new.env(emptyenv())
  
  result$true_positive <- the_table[2,2]
  result$true_negative <- the_table[1,1]
  result$false_positive <- the_table[2,1]
  result$false_negative <- the_table[1,2]
  
  result$positive <- result$true_positive + result$false_negative
  result$negative <- result$true_negative + result$false_positive
  
  result$true_positive_rate <- result$true_positive/result$positive 
  result$false_positive_rate <- result$false_positive/result$negative 

  result$roc <- c(false_positive_rate=result$false_positive_rate, true_positive_rate=result$true_positive_rate )  
  
  
  result

}

pcxqda <- function(the_principal_components, the_categories) {
  
  result <- new.env(emptyenv())
  result$my_category_table <- the_categories %>% table()
  
  result$df <- cbind(the_categories, the_principal_components)
  
  result$how_many_cols_to_use <- function() min( min(result$my_category_table)/2, ncol(the_principal_components))
  
  result$qqda0 <- MASS::qda(the_principal_components[,1:result$how_many_cols_to_use()] , the_categories )
  result$get_pr_comp_on_which_to_regress <- function () the_principal_components[,1:result$how_many_cols_to_use()]
  


  result$ff1 <- function(the_proportion) {
    rresult <- new.env(emptyenv())
    the_pr_comp_on_which_to_regress <- result$get_pr_comp_on_which_to_regress ()  
    n <- nrow(the_pr_comp_on_which_to_regress)
    
    tr <- sample(1:n, floor(the_proportion*n) )
    train <- the_pr_comp_on_which_to_regress[tr,]
    test <- the_pr_comp_on_which_to_regress[-tr,]
    rresult$z <- MASS::qda(train, the_categories[tr])

    rresult$table <- table(pred=predict(rresult$z, test)$class, true=the_categories[-tr])
    rresult$roc <- some_table_information(rresult$table)
    rresult
  }
  
  result$ff2 <- function(the_proportion, the_prior) {
    rresult <- new.env(emptyenv())
    the_pr_comp_on_which_to_regress <- result$get_pr_comp_on_which_to_regress ()  
    n <- nrow(the_pr_comp_on_which_to_regress)
    
    tr <- sample(1:n, floor(the_proportion*n) )
    train <- the_pr_comp_on_which_to_regress[tr,]
    test <- the_pr_comp_on_which_to_regress[-tr,]
    rresult$z <- MASS::qda(train, the_categories[tr])
    
    rresult$table <- table(pred=predict(rresult$z, test, prior=c(the_prior, 1-the_prior))$class, true=the_categories[-tr])
    rresult$roc <- some_table_information(rresult$table)
    rresult
  }
  
    result$ff3_lda <- function(the_proportion, the_prior) {
    rresult <- new.env(emptyenv())
    the_pr_comp_on_which_to_regress <- result$get_pr_comp_on_which_to_regress ()  
    n <- nrow(the_pr_comp_on_which_to_regress)
    
    tr <- sample(1:n, floor(the_proportion*n) )
    train <- the_pr_comp_on_which_to_regress[tr,]
    test <- the_pr_comp_on_which_to_regress[-tr,]
    rresult$z <- MASS::lda(train, the_categories[tr])
    
    rresult$table <- table(pred=predict(rresult$z, test, prior=c(the_prior, 1-the_prior))$class, true=the_categories[-tr])
    rresult$roc <- some_table_information(rresult$table)
    rresult
  }


  result
  
  
}




the_categories <- rep(1, nrow(business_cases_year_17))
the_categories[ business_cases_year_17$CIO_Evaluation_Color=="Green"] <- 0
# the_categories[ business_cases_year_17$CIO_Evaluation_Color=="Red"] <- 2

pq0 <- pcxqda(p0$my_projection_matrix[,-1], the_categories)

x0 <- pq0$ff1(.9)

# x0 %>% ls.str()
# x0$roc %>% ls.str()
# x0$table
```


```{r}


df0 <- data.frame(  t(pq0$ff3_lda(.9, 0)$roc$roc) )
for (k in 1:100) df0 <- df0 %>% rbind(t(pq0$ff3_lda(.9, k/100)$roc$roc ))

df0

plot(true_positive_rate~false_positive_rate, data=df0)
abline(0,1, col='blue')


```








```{r}



ff1 <- function() {

tr <- sample(1:nrow(q0), 600)
train <- q0[tr,]
test <- q0[-tr,]
z <- qda(train, the_categories[tr])
table(predict(z, test)$class, the_categories[-tr])

}

ffnaive <- function() {
  
  tr <- sample(1:nrow(q0), 600)
  train <- q0[tr,]
  test <- q0[-tr,]
  # z <- qda(train, the_categories[tr])
  
  
  table(rep(3,the_categories[-tr]%>%length() ), the_categories[-tr])
  
}



ffn <- function() {

tr <- sample(1:nrow(q0), 600)
train <- q0[tr,]
test <- q0[-tr,]
z <- qda(train, the_categories[tr])
e0 <- table(predict(z, test)$class, the_categories[-tr])

error_rate <- function(e0) {
  ok <- 1:(e0 %>% nrow()) %>% map(~e0[.,.]) %>% unlist() %>% sum()
  tot <- e0 %>% sum()
  (tot-ok)/tot
}

e0 %>% error_rate()

}



e1 <- 1:99 %>% map(~ffn()) %>% unlist()

```


```{r}

ff1()

ffenaive <- function() {
  n0 <- ffnaive()
  (sum(n0)-n0[1,3])/sum(n0)
}

e2 <- 1:99 %>% map(~ffenaive()) %>% unlist()


```






```{r}


fn <- function(p0) {
  df_ <- data.frame(p0$project_onto_principal_component(1))
  for (k in 2:10) df_ <- df_ %>% cbind(p0$project_onto_principal_component(k) )
  df_
}

fn(p0)


```









```{r}
x17$uui <- (x17$uui02 + x17$uui01*1000000000 )



x17 <- x17[, c(1, 4,5)]
the_color <- rep(1, nrow(x0))
the_color[ x17$CIO_Evaluation_Color=='Green' ] <- 3
the_color[ x17$CIO_Evaluation_Color=='Red' ]   <- 2

x17 <- x17 %>% cbind(the_color)
x17 <- x17[,-2]

```


get incidence of each of these nice words, in the business case descriptions

```{r}

get_incidence <- function(the_col, the_word) {
  grepl(the_word, the_col, fixed=TRUE)
}


m17 <- data.frame( x17$uui )

for (it in names(mt1) ) m17 <- m17 %>% cbind(x17$Brief_Summary %>% get_incidence(it) )

colnames(m17) <- c("uui", paste0("w_", names(mt1) ))

```

Get the projection of the original business case summaries back down into the principal components.

```{r}

project_onto_kth_component <- function(pcompmtx, domain, k) {

   (domain %>% as.numeric()) %*% (pcompmtx$rotation[,k] %>% as.numeric())

}

project_all_onto_kth_component <- function( pcompmtx, domain, k) { 

  1:nrow(domain) %>% map( ~ project_onto_kth_component( pcompmtx,  domain[.,-1], k )) %>% unlist()

}


x17 <- x17 %>% cbind( pcx1=p0 %>% project_all_onto_kth_component ( m17, 1) )
x17 <- x17 %>% cbind( pcx2=p0 %>% project_all_onto_kth_component ( m17, 2) )
# p0 %>% project_all_onto_kth_component ( m0, 1)

```



```{r}

plot(pcx2~pcx1, col=the_color, data=x17)

```


```{r}


qda0 %>% predict( x17[,4:5])

```






